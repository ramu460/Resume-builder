{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}
{% load custom_filters %}

{% block title %}{{resume_form.instance.pk|yesno:"Edit Resume,Create Resume"}} - Resume Builder{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">
            {{ resume_form.instance.pk|yesno:"Edit Resume,Create Resume"}}
        </h1>
    </div>

    <div class="flex flex-col md:flex-row gap-6">
        <!-- Left sidebar navigation -->
        <div class="md:w-1/4">
            <div class="bg-white rounded-lg shadow-sm p-4 sticky top-4">
                <h3 class="font-semibold text-lg mb-4 text-gray-800">Resume Sections</h3>
                <ul class="space-y-2" id="resume-sections-nav">
                    <li>
                        <a href="#basic-info" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 nav-link" data-section="basic-info">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Basic Info
                        </a>
                    </li>
                    <li>
                        <a href="#education" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 nav-link" data-section="education">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222"></path>
                            </svg>
                            Education
                        </a>
                    </li>
                    <li>
                        <a href="#experience" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 nav-link" data-section="experience">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Experience
                        </a>
                    </li>
                    <li>
                        <a href="#skills" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 nav-link" data-section="skills">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            Skills
                        </a>
                    </li>
                    <li>
                        <a href="#projects" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 nav-link" data-section="projects">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            Projects
                        </a>
                    </li>
                    <li>
                        <a href="#certifications" class="flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 nav-link" data-section="certifications">
                            <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            Certifications
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main form content -->
        <div class="md:w-3/4">
            <form method="POST" class="space-y-6">
                {% csrf_token %}
                
                <!-- Basic Info -->
                <div id="basic-info" class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Basic Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {% for field in resume_form %}
                        {% if field.name != 'skills' and field.name != 'state' %}
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ field.label }}</label>
                            {% render_field field class="block w-full px-3 py-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" %}
                            {% if field.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                           <!-- Manually render ONLY the working state field (with id="state_field") -->
                        <div class="mb-4" id="state_field">
                            <label class="block text-sm font-medium text-gray-700 mb-1">State/Province</label>
                            <select 
                                name="state" 
                                id="id_state" 
                                class="block w-full px-3 py-2.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                            >
                                <option value="">Select Country First</option>
                            </select>
                            <!-- Display Django errors if any -->
                            {% if resume_form.state.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ resume_form.state.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- formsets -->
                {% include 'resumes/_formset.html' with formset=education_formset title='Education' prefix='education' id='education' %}
                {% include 'resumes/_formset.html' with formset=experience_formset title='Work Experience' prefix='experience' id='experience' %}
                
                <!-- Skills Section -->
                <div id="skills" class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Skills</h3>
                    
                    <!-- Selected Skills Display -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Skills:</label>
                        <div id="selected-skills-container" class="flex flex-wrap gap-2 min-h-12">
                            {% for skill in skills %}
                            <div class="skill-card" data-skill-id="{{ skill.id }}" data-category="{{ skill.category|default:'general' }}">
                                {{ skill.name }}
                                <button type="button" class="remove-skill-btn" onclick="removeSkill('{{ skill.id }}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="skills" id="skills-hidden-input" value="{% for skill in skills %}{{ skill.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                    </div>

                    <!-- Skill Categories Dropdowns -->
                    <div class="space-y-4">
                        {% for category in skill_categories %}
                        <div class="skill-category-group relative">
                            <button type="button" 
                                    class="dropdown-toggle-btn flex justify-between items-center w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 transition-all"
                                    onclick="toggleDropdown('{{ category.0 }}')">
                                <span class="font-medium">{{ category.1 }}</span>
                                <svg class="w-5 h-5 transition-transform" id="{{ category.0 }}-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <div id="{{ category.0 }}-dropdown" class="dropdown-content hidden mt-2">
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 p-2">
                                    {% for skill in skills_by_category|get_item:category.0 %}
                                    <button type="button" 
                                            class="skill-option text-left px-3 py-2 hover:bg-blue-50 rounded-md transition-colors"
                                            onclick="addSkill('{{ skill.id }}', '{{ skill.name }}', '{{ category.0 }}')">
                                        {{ skill.name }}
                                    </button>
                                    {% empty %}
                                    <p class="text-gray-500 col-span-3">No skills found in this category</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                {% include 'resumes/_formset.html' with formset=project_formset title='Projects' prefix='project' id='projects' %}
                {% include 'resumes/_formset.html' with formset=certification_formset title='Certifications' prefix='certification' id='certifications' %}

                <!-- Finalize Section -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Finalize Your Resume</h3>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="terms" name="terms" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded" required>
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="terms" class="font-medium text-gray-700">I confirm that the information provided is accurate</label>
                                <p class="text-gray-500">By checking this box, you agree that all information is correct to the best of your knowledge.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form actions -->
                <div class="flex justify-between mt-8 bg-white p-4 rounded-lg border">
                    <a href="{% url 'resume_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </a>
                    <div class="space-x-3">
                        <button name="save_draft" type="submit" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Save Draft
                        </button>
                        <button type="submit" class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                            Save Resume
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/resume_form.js' %}"></script>
<script>
// Initialize selected skills
let selectedSkills = new Set();

document.addEventListener('DOMContentLoaded', function() {
    // Initialize from existing skills
    const hiddenInput = document.getElementById('skills-hidden-input');
    if (hiddenInput && hiddenInput.value) {
        selectedSkills = new Set(hiddenInput.value.split(',').filter(id => id.trim()));
    }
    
    // Highlight current section in sidebar
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('[id^="basic-info"], [id^="education"], [id^="experience"], [id^="skills"], [id^="projects"], [id^="certifications"]');
    
    function highlightActiveSection() {
        let currentSection = '';
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            if (window.scrollY >= (sectionTop - 200)) {
                currentSection = section.getAttribute('id');
            }
        });
        
        navLinks.forEach(link => {
            link.classList.remove('bg-blue-50', 'text-blue-700');
            if (link.getAttribute('data-section') === currentSection) {
                link.classList.add('bg-blue-50', 'text-blue-700');
            }
        });
    }
    
    highlightActiveSection();
    window.addEventListener('scroll', highlightActiveSection);
    
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            navLinks.forEach(l => l.classList.remove('bg-blue-50', 'text-blue-700'));
            this.classList.add('bg-blue-50', 'text-blue-700');
        });
    });
});

// Toggle dropdown
function toggleDropdown(category) {
    const dropdown = document.getElementById(`${category}-dropdown`);
    const arrow = document.getElementById(`${category}-arrow`);
    
    if (dropdown && arrow) {
        dropdown.classList.toggle('hidden');  // Toggle hidden class directly
        arrow.classList.toggle('rotate-180');
        
        // Close other dropdowns
        document.querySelectorAll('.dropdown-content').forEach(d => {
            if (d.id !== `${category}-dropdown`) {
                d.classList.add('hidden'); // Add hidden to close other dropdowns
                const otherArrow = document.getElementById(d.id.replace('-dropdown', '-arrow'));
                if (otherArrow) otherArrow.classList.remove('rotate-180');
            }
        });
    }
}


// Add skill
function addSkill(id, name, category) {
    if (selectedSkills.has(id)) return;
    
    selectedSkills.add(id);
    updateHiddenInput();
    
    const skillCard = document.createElement('div');
    skillCard.className = 'skill-card';
    skillCard.dataset.skillId = id;
    skillCard.dataset.category = category;
    skillCard.innerHTML = `
        ${name}
        <button type="button" class="remove-skill-btn" onclick="removeSkill('${id}')">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    `;
    document.getElementById('selected-skills-container').appendChild(skillCard);
}

// Remove skill
function removeSkill(id) {
    selectedSkills.delete(id);
    updateHiddenInput();
    
    const card = document.querySelector(`.skill-card[data-skill-id="${id}"]`);
    if (card) card.remove();
}

// Update hidden input
function updateHiddenInput() {
    document.getElementById('skills-hidden-input').value = Array.from(selectedSkills).join(',');
}

// Search skills function removed

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.dropdown-toggle-btn') && !event.target.closest('.dropdown-content')) {
        document.querySelectorAll('.dropdown-content').forEach(d => {
            d.classList.add('hidden');
            const arrowId = d.id.replace('-dropdown', '-arrow');
            const arrowElement = document.getElementById(arrowId);
            if (arrowElement) {
                arrowElement.classList.remove('rotate-180');
            }
        });
    }
    
    // Search-related code removed
});
</script>

<style>
.skill-card {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    transition: all 0.2s;
}

/* Category-specific colors */
.skill-card[data-category="programming"] {
    background-color: #e0f2fe;
    color: #0369a1;
}
.skill-card[data-category="framework"] {
    background-color: #ede9fe;
    color: #5b21b6;
}
.skill-card[data-category="frontend"] {
    background-color: #fef3c7;
    color: #92400e;
}
.skill-card[data-category="database"] {
    background-color: #dcfce7;
    color: #166534;
}
.skill-card[data-category="devops"] {
    background-color: #fee2e2;
    color: #991b1b;
}
.skill-card[data-category="mobile"] {
    background-color: #ccfbf1;
    color: #0d9488;
}
.skill-card[data-category="testing"] {
    background-color: #ecfccb;
    color: #3f6212;
}
.skill-card[data-category="tools"] {
    background-color: #e0e7ff;
    color: #3730a3;
}

.skill-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.remove-skill-btn {
    margin-left: 0.5rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
}
.remove-skill-btn:hover {
    opacity: 1;
}

.dropdown-content {
    position: absolute;
    width: 100%;
    background-color: white;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

/* We're using the hidden class to toggle visibility */
.dropdown-content.hidden {
    display: none;
}

.skill-category-group {
    position: relative;
}

.skill-option {
    transition: all 0.2s;
    text-align: left;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    background-color: white;
    border: none;
    cursor: pointer;
}
.skill-option:hover {
    background-color: #e0f2fe !important;
    transform: translateX(2px);
}

.rotate-180 {
    transform: rotate(180deg);
}

/* Navigation link styles */
.nav-link {
    transition: all 0.2s;
}
.nav-link:hover {
    background-color: #f3f4f6;
}
.nav-link.bg-blue-50 {
    background-color: #eff6ff;
    color: #1d4ed8;
}
</style>
<style>
/* Custom select dropdown styling */
select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    background-size: 1.5em;
    padding-right: 2.5rem;
}
</style>
{% endblock %}